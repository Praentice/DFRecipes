# Windows memory analysis
This page aims to give tricks regarding the analysis of Windows memory by using Volatility
## Get a memory dump
### Dumping tools

To retrieve a memory dump from a windows machine, you can use the following tools : 

|Name|Description|Link|
|-|-|-|
|FTK-Imager||[FTK-Imager](https://accessdata.com/product-download/ftk-imager-version-4-2-0)|
|Redline||[Redline](https://fireeye.market/apps/211364)|
|DumpIt.exe||[DumpIt.exe](https://github.com/thimbleweed/All-In-USB/blob/master/utilities/DumpIt/DumpIt.exe?raw=true)|
|WinDD32.exe / WinDD64.exe||[WinDD.exe](https://sourceforge.net/projects/windd/files/windd/WinDD%20Release%201.0/WinDD.zip)|

### Artifacts files
#### Physical machine

Also, you can try to retrieve specifics files if you don't want to dump the memory with the tool. You should search for the following file

|Name|Description|Path|
|-|-|-|
|hiberfil.sys|Hibernation File generated by the Windows OS to speed up the boot process|%SystemDrive%/hiberfil.sys|

#### Virtual machine
In case you have to lead investigations on a virtual machine, you simply need to copy these file without having to interact with the virtual machine : 

|Name|Description|Link|
|-|-|-|
|VMware - .vmem file|||
|Hyper-V - .bin file|||
|Parallels - .mem file|||
|VirtualBox - .sav file||For this type of hypervisor, you will need to dump the memory like a normal bare-metal system|

## Investigation 
### Volatility2
#### Identify the OS system
Before starting the investigation, you will need to determine the OS used on the machine. So, you need to run one of the following commands

```
volatility -f file.dmp imageinfo 
volatility -f file.dmp kdbgscan 
```

Once you have identified the OS used on the machine, save the found profile nearby, you're going to need it for the rest of your investigation when running volatility commands. 
##### General informations on the memory dump
##### Get hostname of computer
###### First way

```
volatility --profile=PROFILE -f file.dmp printkey -K "Software\Microsoft\Windows Media\WMSDK\General"
```
###### Second way

```
volatility --profile=PROFILE -f file.dmp printkey -K "ControlSet001\Control\ComputerName\ActiveComputerName"
```
###### Third way

```
volatility --profile=PROFILE -f file.dmp hivelist # Retrieve virtual address of \REGISTRY\MACHINE\SYSTEM
volatility --profile=PROFILE -f file.dmp `printkey -o virtual_address -K "ControlSet001\services\Tcpip\Parameters"`

```

#### Get the environment variables

```
volatility --profile=PROFILE -f file.dmp envars
```

#### Get the file cached in the memory dump

```
photorec path/to/mem/dump #Get All Files with photorec
volatility --profile=PROFILE -f file.dmp filesystem
``` 

#### Get the list of running processes

##### Get list of process

```
volatility --profile=PROFILE -f file.dmp pslist
```
##### Get hidden processes

```
volatility --profile=PROFILE -f file.dmp psxview
```

##### Get list of loaded modules 

```
volatility --profile=PROFILE -f file.dmp ldrmodules
```

Once you ran this command, lookup for processes with have the 'False' value in one of the following column : Inload, InInit or InMem. Identifying potential suspect process can be useful to speed up the research. 

##### Get list of loaded DLL files 

```
volatility --profile=PROFILE -f file.dmp dlllist #For all the loaded DLL
volatility --profile=PROFILE -f file.dmp dlllist
```
##### Get list of unexcepted patches on the system

```
volatility --profile=PROFILE -f file.dmp apihooks
```

#### Dump a process

##### Dump any process

```
volatility --profile=PROFILE -f path/to/mem/dump memdump -p your_pid --dump-dir .
strings your_pid.dmp > your_pid.txt #Retrieve only strings char from process dump
```

##### Dump malicious process

```
volatility --profile=PROFILE -f file.dmp malfind -D path/to/destination
```
You can then proceed to get a hash from the file and submit it to Virustotal and Hybrid Analysis to know more about the malware you found

##### Dump DLL files used by a process
```
volatility --profile=PROFILE -f file.dmp dlldump --pid=PID -D path/to/destination
```

#### Get command list

```
volatility --profile=PROFILE -f path/to/mem/dump cmdlist
```

#### Informations on network connections

#### Dump current network connections

```
volatility --profile=PROFILE -f path/to/mem/dump netscan #Does not support WindowsXP profile
```

### Volatility3

#### Identify the OS system

```
vol -f path/to/file banners.Banners #Get banners of memory dump
vol -f path/to/file imageinfo #Get information regarding
vol -f path/to/file windows.info
```

NTBuildLab : Build version of the OS
SystemTime : Time at which the memory dump was done

#### Get the environment variables

```
vol -f path/to/file windows.envars
```

#### Get the file cached in the memory dump

```
vol -f path/to/file windows.filescan
```

#### Processes

##### Get the list of running processes
```
vol -f path/to/file windows.pslist
vol -f path/to/file windows.psscan
vol -f path/to/file windows.pstree
```

##### Dump a process

```
vol -f path/to/file -o /path/to/dump/dir windows.memmap.Memmap --pid=pid_proc --dump
```

##### Search valuables informations within process dump
In case you want to analyze a process dump, please check this page.

##### Get DLL imported by process

```
vol -f path/to/file windows.dlllist | grep pid
```

#### Get command list

```
vol -f path/to/file windows.cmdlist
```

#### Informations on network connections

```
vol -f path/to/file windows.netstat
```

## Ressources
[SANS Institute memory forensic cheat sheet v1.2](https://assets.contentstack.io/v3/assets/blt36c2e63521272fdc/bltc7925ba3238b6e04/5e345fb87ca70442647a61f7/Memory-Forensics-Cheat-Sheet-v1_2.pdf)


